# ========================================
# Intelligent Search Agent Demo - Makefile
# ========================================

.PHONY: help install dev clean \
        setup-env init-db generate-data validate-data \
        run-api run-qdrant run-qdrant-bg stop-qdrant \
        generate-embeddings \
        test test-api test-db test-qdrant test-integration \
        format lint check \
        deploy deploy-basic deploy-full \
        status health logs \
        reset clean-all

# ----------------------------------------
# Help and Information
# ----------------------------------------

help: ## ğŸ“‹ Show this help message with available commands
	@echo ""
	@echo "ğŸ¤– Intelligent Search Agent Demo - Available Commands"
	@echo "=================================================="
	@echo ""
	@echo "ğŸ“¦ Setup & Installation:"
	@grep -E '^[a-zA-Z_-]+:.*?## ğŸ“¦.*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m  %-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ğŸ—„ï¸  Database Management:"
	@grep -E '^[a-zA-Z_-]+:.*?## ğŸ—„ï¸.*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m  %-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ğŸš€ Services:"
	@grep -E '^[a-zA-Z_-]+:.*?## ğŸš€.*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m  %-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ğŸ§ª Testing:"
	@grep -E '^[a-zA-Z_-]+:.*?## ğŸ§ª.*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m  %-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ğŸ”§ Development:"
	@grep -E '^[a-zA-Z_-]+:.*?## ğŸ”§.*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m  %-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ğŸ¯ Deployment:"
	@grep -E '^[a-zA-Z_-]+:.*?## ğŸ¯.*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m  %-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ğŸ“Š Monitoring:"
	@grep -E '^[a-zA-Z_-]+:.*?## ğŸ“Š.*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m  %-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ğŸ§¹ Cleanup:"
	@grep -E '^[a-zA-Z_-]+:.*?## ğŸ§¹.*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m  %-20s\033[0m %s\n", $$1, $$2}'
	@echo ""

# ----------------------------------------
# Setup & Installation
# ----------------------------------------

install: ## ğŸ“¦ Install production dependencies
	@echo "ğŸ“¦ Installing production dependencies..."
	pip install -r requirements.txt
	@echo "âœ… Dependencies installed successfully!"

dev: ## ğŸ“¦ Install development dependencies (includes code quality tools)
	@echo "ğŸ“¦ Installing development dependencies..."
	pip install -r requirements.txt
	@echo "ğŸ”§ Installing development tools..."
	pip install black>=23.0.0 flake8>=6.0.0 mypy>=1.7.0 isort>=5.12.0
	@echo "âœ… Development environment ready!"

setup-env: ## ğŸ“¦ Setup environment variables (copy .env.example to .env)
	@if [ ! -f .env ]; then \
		echo "ğŸ“ Creating .env file from template..."; \
		cp .env.example .env; \
		echo "âš ï¸  Please edit .env and configure your GLM-4 API key!"; \
	else \
		echo "âœ… .env file already exists"; \
	fi

# ----------------------------------------
# Database Management  
# ----------------------------------------

init-db: ## ğŸ—„ï¸ Initialize SQLite database with schema
	@echo "ğŸ—„ï¸ Initializing SQLite database..."
	python src/database/init_database.py
	@echo "âœ… Database initialized successfully!"

generate-data: ## ğŸ—„ï¸ Generate test data (1000 user records)
	@echo "ğŸ—„ï¸ Generating test data..."
	python src/database/generate_test_data.py
	@echo "âœ… Test data generated successfully!"

validate-data: ## ğŸ—„ï¸ Validate database data integrity
	@echo "ğŸ—„ï¸ Validating database data..."
	python src/database/validate_data.py
	@echo "âœ… Data validation completed!"

db-setup: init-db generate-data validate-data ## ğŸ—„ï¸ Complete database setup (init + data + validation)
	@echo "ğŸ‰ Database setup completed!"

# ----------------------------------------
# Services
# ----------------------------------------

run-api: ## ğŸš€ Start FastAPI server (localhost:8000)
	@echo "ğŸš€ Starting FastAPI server..."
	@echo "ğŸ“ API will be available at: http://localhost:8000"
	@echo "ğŸ“š API docs at: http://localhost:8000/docs"
	uvicorn src.api.main:app --host 0.0.0.0 --port 8000 --reload

run-api-prod: ## ğŸš€ Start FastAPI server in production mode
	@echo "ğŸš€ Starting FastAPI server (production mode)..."
	uvicorn src.api.main:app --host 0.0.0.0 --port 8000

run-qdrant: ## ğŸš€ Start Qdrant vector database (localhost:6333) - foreground
	@echo "ğŸš€ Starting Qdrant vector database..."
	@echo "ğŸ“ Qdrant will be available at: http://localhost:6333"
	@echo "ğŸŒ Web UI at: http://localhost:6333/dashboard"
	docker run --name qdrant --rm \
		-p 6333:6333 \
		-v $$(pwd)/qdrant_storage:/qdrant/storage \
		qdrant/qdrant

run-qdrant-bg: ## ğŸš€ Start Qdrant vector database in background
	@echo "ğŸš€ Starting Qdrant vector database in background..."
	docker run -d --name qdrant \
		-p 6333:6333 \
		-v $$(pwd)/qdrant_storage:/qdrant/storage \
		qdrant/qdrant
	@echo "âœ… Qdrant started in background"
	@echo "ğŸ“ Available at: http://localhost:6333"

stop-qdrant: ## ğŸš€ Stop Qdrant vector database
	@echo "ğŸ›‘ Stopping Qdrant vector database..."
	-docker stop qdrant
	-docker rm qdrant
	@echo "âœ… Qdrant stopped"

generate-embeddings: ## ğŸš€ Generate and import vector embeddings (requires Qdrant)
	@echo "ğŸš€ Generating vector embeddings..."
	@echo "â³ This may take 10-30 minutes depending on your hardware..."
	python src/vector_search/generate_embeddings.py
	@echo "âœ… Vector embeddings generated and imported!"

# ----------------------------------------
# Testing
# ----------------------------------------

test: ## ğŸ§ª Run all tests
	@echo "ğŸ§ª Running all tests..."
	pytest tests/ -v

test-api: ## ğŸ§ª Test API endpoints (requires running API server)
	@echo "ğŸ§ª Testing API endpoints..."
	pytest tests/test_api.py -v

test-db: ## ğŸ§ª Test database integration
	@echo "ğŸ§ª Testing database integration..."
	pytest tests/test_database_integration.py -v

test-qdrant: ## ğŸ§ª Test Qdrant connection (requires running Qdrant)
	@echo "ğŸ§ª Testing Qdrant connection..."
	pytest tests/test_qdrant_connection.py -v

test-integration: ## ğŸ§ª Test intelligent search agent (requires full setup)
	@echo "ğŸ§ª Testing intelligent search agent..."
	pytest tests/test_integration.py -v

test-basic: test-db test-api ## ğŸ§ª Run basic tests (database + API)
	@echo "âœ… Basic tests completed!"

test-full: test test-qdrant test-integration ## ğŸ§ª Run full test suite (requires complete setup)
	@echo "âœ… Full test suite completed!"

test-coverage: ## ğŸ§ª Run tests with coverage report
	@echo "ğŸ§ª Running tests with coverage..."
	pytest tests/ --cov=src --cov-report=html --cov-report=term
	@echo "ğŸ“Š Coverage report generated in htmlcov/"

# ----------------------------------------
# Development Tools
# ----------------------------------------

format: ## ğŸ”§ Format code with black and isort
	@echo "ğŸ”§ Formatting code..."
	black src/ tests/
	isort src/ tests/
	@echo "âœ… Code formatted!"

lint: ## ğŸ”§ Run linting (flake8 + mypy)
	@echo "ğŸ”§ Running linters..."
	flake8 src/ tests/ --max-line-length=100
	mypy src/ --ignore-missing-imports
	@echo "âœ… Linting completed!"

check: format lint ## ğŸ”§ Format code and run linting
	@echo "âœ… Code quality check completed!"

clean: ## ğŸ”§ Clean up cache files and temporary files
	@echo "ğŸ§¹ Cleaning up cache files..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -name "*.pyc" -delete 2>/dev/null || true
	find . -name "*.pyo" -delete 2>/dev/null || true
	find . -name "*.pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -name ".coverage" -delete 2>/dev/null || true
	rm -rf htmlcov/ 2>/dev/null || true
	@echo "âœ… Cleanup completed!"

# ----------------------------------------
# Deployment Shortcuts
# ----------------------------------------

deploy-basic: setup-env install db-setup run-api ## ğŸ¯ Deploy basic functionality (database + API)
	@echo "ğŸ‰ Basic deployment completed!"
	@echo "ğŸ“ API available at: http://localhost:8000"

deploy-full: setup-env install db-setup ## ğŸ¯ Deploy full system (interactive setup)
	@echo "ğŸ¯ Starting full deployment..."
	@echo "1ï¸âƒ£ Database and API setup completed"
	@echo "2ï¸âƒ£ Next: Start Qdrant with 'make run-qdrant-bg'"
	@echo "3ï¸âƒ£ Then: Generate embeddings with 'make generate-embeddings'"
	@echo "4ï¸âƒ£ Finally: Test with 'make test-full'"

# ----------------------------------------
# Monitoring & Status
# ----------------------------------------

status: ## ğŸ“Š Check status of all services
	@echo "ğŸ“Š Checking service status..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "ğŸ—„ï¸ Database:"
	@if [ -f quesai_test.db ]; then \
		echo "  âœ… SQLite database exists"; \
		sqlite3 quesai_test.db "SELECT COUNT(*) || ' users' FROM user_profiles;" 2>/dev/null || echo "  âŒ Database error"; \
	else \
		echo "  âŒ Database not found"; \
	fi
	@echo ""
	@echo "ğŸŒ API Server:"
	@curl -s http://localhost:8000/health > /dev/null 2>&1 && echo "  âœ… API server running (http://localhost:8000)" || echo "  âŒ API server not running"
	@echo ""
	@echo "ğŸ” Qdrant Vector Database:"
	@curl -s http://localhost:6333/health > /dev/null 2>&1 && echo "  âœ… Qdrant running (http://localhost:6333)" || echo "  âŒ Qdrant not running"
	@echo ""
	@echo "ğŸ³ Docker Containers:"
	@docker ps --format "table {{.Names}}\t{{.Status}}" --filter name=qdrant 2>/dev/null || echo "  âŒ Docker not available"

health: ## ğŸ“Š Quick health check of running services
	@echo "ğŸ” Quick health check..."
	@curl -s http://localhost:8000/health && echo "" || echo "âŒ API not responding"
	@curl -s http://localhost:6333/health && echo "âœ… Qdrant healthy" || echo "âŒ Qdrant not responding"

logs: ## ğŸ“Š Show Qdrant container logs
	@echo "ğŸ“‹ Qdrant container logs:"
	docker logs qdrant --tail=50

# ----------------------------------------
# Cleanup & Reset
# ----------------------------------------

clean-all: clean stop-qdrant ## ğŸ§¹ Complete cleanup (stop services + clean cache)
	@echo "ğŸ§¹ Performing complete cleanup..."
	@echo "âœ… All cleanup completed!"

reset: clean-all ## ğŸ§¹ Reset everything (remove database, stop services, clean cache)
	@echo "ğŸ§¹ Resetting project to clean state..."
	@read -p "âš ï¸  This will delete the database and vector data. Continue? (y/N) " confirm && [ $$confirm = y ]
	rm -f quesai_test.db
	rm -rf qdrant_storage/
	@echo "âœ… Project reset completed!"

# ----------------------------------------
# Quick Start Aliases
# ----------------------------------------

start: setup-env install db-setup run-api ## ğŸ¯ Quick start - basic functionality
start-full: deploy-full ## ğŸ¯ Quick start - full setup guide